import os
from pyrogram import Client, filters
from pyrogram.types import Message, ChatPermissions

# User Account (Ğ½Ğµ Ğ±Ğ¾Ñ‚!)
API_ID = int(os.getenv('API_ID'))
API_HASH = os.getenv('API_HASH')
PHONE = os.getenv('PHONE_NUMBER')  # Ğ’Ğ°Ñˆ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°

# ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ĞºĞ°Ğº Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
app = Client("user_account", api_id=API_ID, api_hash=API_HASH, phone_number=PHONE)

restricted = ChatPermissions(can_send_messages=False)
unrestricted = ChatPermissions(can_send_messages=True)

async def count_user_messages(chat_id, user_id):
    """Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    count = 0
    async for message in app.get_chat_history(chat_id):
        if message.from_user and message.from_user.id == user_id:
            count += 1
        if count >= 10:  # Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
            break
    return count

@app.on_message(filters.group & filters.text)
async def handle_message(client, message: Message):
    """ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"""
    user_id = message.from_user.id
    chat_id = message.chat.id
    
    count = await count_user_messages(chat_id, user_id)
    
    if count >= 4:
        await app.restrict_chat_member(chat_id, user_id, restricted)
        print(f"ğŸš« Restricted {user_id} ({count} messages)")

@app.on_deleted_messages()
async def handle_deleted(client, messages):
    """Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ"""
    for message in messages:
        if message.from_user:
            user_id = message.from_user.id
            chat_id = message.chat.id
            
            count = await count_user_messages(chat_id, user_id)
            
            if count < 4:
                await app.restrict_chat_member(chat_id, user_id, unrestricted)
                print(f"âœ… Unrestricted {user_id} ({count} messages)")

if __name__ == "__main__":
    app.run()
